---
title: "Mysis_Dry_Compare"
author: "Andrew Ingalls"
date: "1/1/2022"
output: html_document
---
#Mysis vs. Dry Feed Comparison Study


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(openxlsx)
library(tidyverse)
library(lsmeans)
library(plotly)
library(outliers)
library(ggridges)
library(viridis)
library(hrbrthemes)
library(ggResidpanel)
library(qqplotr)
library(EnvStats)

```

## Data Cleaning
These data have some unecessary columns, some poorly titled columns, 
as well as some categories that are not standardize over the time of the project. 
This section will be the cleaning stage of the project

```{r Data_Cleaning, include=TRUE}

df_growth<-read.xlsx("../data/Mysis_Pilot.xlsx", 
                     sheet="Exp_1",detectDates=T)
df_survival<-read.xlsx("../data/Mysis_Pilot.xlsx", 
                       sheet="Survival Census (Progress)",detectDates=T)
df_sex_sort <-read.xlsx("../data/Mysis_Pilot.xlsx", 
                        sheet="Sexing",detectDates=T)

head(df_growth)
head(df_survival)
head(df_sex_sort)

summary(df_growth)
summary(df_survival)
summary(df_sex_sort)

#df_Growth Cleanup
#Remove unneeded columns from df_growth such as Time
#Remove 'age' because samples were taken over the course of 3 days, 
#which is why age-category was added
df_growth <- subset(df_growth,select=-c(Time, Age,Possible.Outliers,Condition.Factor)) 

#rename columns for ease of use
colnames(df_growth) <- c("Date", "Tank", "Age_Category","Feed_Group",
                         "Length_mm","Mass_mg")

#changes types and create factors where needed
cols <- c("Tank", "Age_Category","Feed_Group")
df_growth[cols] <- lapply(df_growth[cols], factor)

#check
sapply(df_growth,class)

#reorder age and age category factor levels
df_growth$Age_Category <- factor(df_growth$Age_Category, 
                                 levels = c("Three Months", "Five Months",
                                             "Six Months", "Eight Months", 
                                             "Nine Months","Twelve Months"))

#Check for NAs
df_growth[!complete.cases(df_growth),]

#standardize tank location
old_tank_list <-  c("7.C.4","7.C.5","7.C.6","7.C.7","7.C.8","7.C.9",
                    "7.C.10","7.C.11")
old_tank_list_2nd <- c("7.B.3-4","7.C.3-4","7.C.1-2","7.C.5-6","7.C.7-8",
                       "7.C.9-10","7.E.9-10","7.C.11-12")
new_tank_list <-  c("7.E.3-4","7.E.1-2","7.D.7-8","7.E.11-12","7.D.1-2",
                    "7.D.3-4","7.E.9-10","7.D.5-6")

#batch change the tank locations based on the lists above which was the first 
#mass move of tanks (readme.md)
df_growth <- df_growth %>%
  mutate(Tank = recode(Tank, !!!setNames(new_tank_list, old_tank_list)))

#batch change again for the second mass move of tanks(readme.md)
df_growth <- df_growth %>%
  mutate(Tank = recode(Tank, !!!setNames(new_tank_list, old_tank_list_2nd)))

#Check to make sure we only have 8 tank levels
summary(df_growth)
levels(df_growth$Tank)



#Clean up df_survival

#Remove columns that were just interm calculations in excel. Not needed
df_survival <- subset(df_survival,select=-c(Lost,Total,Male,Female,Unknown)) 

#rename columns for consistency
colnames(df_survival) <- c("Date", "Tank","Feed_Group", "Census")

#batch change the tank locations based on the lists above which was the 
#first mass move of tanks (readme.md)
df_survival <- df_survival %>%
  mutate(Tank = recode(Tank, !!!setNames(new_tank_list, old_tank_list)))

#batch change again for the second mass move of tanks(readme.md)
df_survival <- df_survival %>%
  mutate(Tank = recode(Tank, !!!setNames(new_tank_list, old_tank_list_2nd)))

#Change Tank and Group into Factors
df_survival$Tank <- factor(df_survival$Tank) 
df_survival$Feed_Group <- factor(df_survival$Feed_Group)



#Cleanup Sex_sort data

#remove time column
df_sex_sort <- subset(df_sex_sort, select = -Time)

#Factor Tank and Group
df_sex_sort$Tank <- factor(df_sex_sort$Tank)
df_sex_sort$Group <- factor(df_sex_sort$Group)


#Check all changes using head() summary() and levels()
```

## Exploritory Data Analysis for Growth

Here we will focus on our Growth data. Do we see a normal distribution of data?
Is there a correlation between mass and length?
Condition Factor is a method for showing the health of a fish (similar to BMI)
Do we see condition factor change with age? Any other parameters change with age?
What do we see for outliers? Can these be removed or are they true?
What do our residuals look like, can we use linear regression to explain this?
What does the confidence interval look like for both Feed Groups?
Are we seeing any significant difference between the Feed Groups in the variables?


```{r pressure, echo=FALSE}

#histogram for Mass (Right skewed)
ggplot(df_growth, aes(x=Mass_mg))+geom_histogram(aes(y=..density..))+
  geom_vline(aes(xintercept=mean(Mass_mg)), color="blue", linetype="dashed",size=1)+
  geom_density(alpha=0.2,fill="#FF6666")+
  theme_bw()

#histogram for Length (double peak)
ggplot(df_growth, aes(x=Length_mm))+geom_histogram(aes(y=..density..))+
  geom_vline(aes(xintercept=mean(Length_mm)), color="blue", linetype="dashed",size=1)+
  geom_density(alpha=0.2,fill="#FF6666")+
  theme_bw()


#Histogram by Groups

#MASS
ggplot(df_growth, aes(x=Mass_mg, color=Feed_Group))+geom_histogram(aes(y=..density..),fill='white',alpha=0.5)+
  geom_vline(aes(xintercept=mean(Mass_mg)), color="blue", linetype="dashed",size=1)+
  geom_density(alpha=0.2,fill="#FF6666")+
  theme_bw()+scale_color_brewer(palette="Dark2")
#Length
ggplot(df_growth, aes(x=Length_mm, color=Feed_Group))+geom_histogram(aes(y=..density..),fill="white",alpha=0.5)+
  geom_vline(aes(xintercept=mean(Length_mm)), color="blue", linetype="dashed",size=1)+
  geom_density(alpha=0.2,fill="#FF6666")+
  theme_bw()+scale_color_brewer(palette="Dark2")
#Histogram Plot of Mass for Ages and Groups
ggplot(df_growth, aes(x=Mass_mg, color=Feed_Group))+geom_density(alpha=0.2,fill='grey') + 
  facet_wrap(~Age_Category)

#Histogram Plot of Length for Ages and Groups
ggplot(df_growth, aes(x=Length_mm, color=Feed_Group))+geom_density(alpha=0.2,fill='grey') + 
  facet_wrap(~Age_Category)

ggplot(df_growth, aes(x=Length_mm,y=Age_Category, fill=..x..))+
  geom_density_ridges_gradient(scale=3, rel_min_height=0.01)+
  scale_fill_viridis(name="Length_mm",option="C")+
  labs(title='Mass of Surface Morph by Age')+
  theme_ipsum()+
  theme(
    legend.position = 'none',
    panel.spacing = unit(0.1,'lines'),
    strip.text.x = element_text(size=8)
  ) +
  facet_wrap(~Feed_Group,ncol=1)

ggplot(df_growth, aes(x=Mass_mg,y=Age_Category, fill=..x..))+
  geom_density_ridges_gradient(scale=3, rel_min_height=0.01)+
  scale_fill_viridis(name="Mass_mg",option="C")+
  labs(title='Mass of Surface Morph by Age')+
  theme_ipsum()+
  theme(
    legend.position = 'none',
    panel.spacing = unit(0.1,'lines'),
    strip.text.x = element_text(size=8)
  ) +
  facet_wrap(~Feed_Group,ncol=1)


#Box plot of Mass vs Age for Groups

ggplot(df_growth,aes(y=Mass_mg, x=Age_Category,fill=Feed_Group)) + geom_boxplot(outlier.color='red',outlier.shape=1)

#Box plot of Length vs Age for Groups

ggplot(df_growth,aes(y=Length_mm, x=Age_Category,fill=Feed_Group)) + geom_boxplot(outlier.color='red',outlier.shape=1)

#Violin plot
ggplot(df_growth,aes(y=Mass_mg, x=Age_Category,fill=Feed_Group)) + geom_violin()+stat_summary(fun=median,geom='point',size=2,color='red')+
  facet_wrap(~Feed_Group)+theme_bw()+theme(axis.text.x=element_text(angle=45,hjust=1))

ggplot(df_growth,aes(y=Length_mm, x=Age_Category,fill=Feed_Group)) + geom_violin()+stat_summary(fun=median,geom='point',size=2,color='red')+
  facet_wrap(~Feed_Group)+theme_bw()+theme(axis.text.x=element_text(angle=45,hjust=1))

#Understanding growth based on Age category
ggplot(df_growth, aes(y=Age_Category,x=Mass_mg, color=Feed_Group))+geom_point(alpha=0.5)
ggplot(df_growth, aes(y=Age_Category,x=Length_mm, color=Feed_Group))+geom_point(alpha=0.5)


```
##Normal Probability Plot
In order to understand our outliers, we need to assume that there is a normal
distribution of data. We will check our normality assumoption with a normal probabilty 
plot.

```{r Normal Probability Plot of Each Age Category for Mass and Length}
#Mass
#iterate through the age levels of the gemma database, create a normal plot for each
#age group using qqplotr and ggplot
for (AgeCategory in levels(growth_gemma_outlier_df$Age_Category)){
  Group_df <- growth_gemma_outlier_df %>%
  filter(Age_Category == AgeCategory)
  #Mass Normal Distribution for each Age
  v <- ggplot(mapping = aes(sample =Group_df$Mass_mg)) + stat_qq_point(size = 2) +
    stat_qq_line(color = "green") + xlab("Normal N(0,1) Order Statistic Medians") +
    ylab("Ordered Response") + labs(title = paste("Gemma Mass Normal Probabilty Plot: ", AgeCategory))
  print(v)
  }

#same for Mysis
for (AgeCategory in levels(growth_mysis_outlier_df$Age_Category)){
  Group_df <- growth_mysis_outlier_df %>%
  filter(Age_Category == AgeCategory)
  #Mass Normal Distribution for each Age
  v <- ggplot(mapping = aes(sample =Group_df$Mass_mg)) + stat_qq_point(size = 2) +
    stat_qq_line(color = "green") + xlab("Normal N(0,1) Order Statistic Medians") +
    ylab("Ordered Response") + labs(title = paste("Mysis Mass Normal Probabilty Plot: ", AgeCategory))
  print(v)
  }
#Length Normal Distribution for each Age
#iterate through the age levels of the gemma database, create a normal plot for each
#age group using qqplotr and ggplot
for (AgeCategory in levels(growth_gemma_outlier_df$Age_Category)){
  Group_df <- growth_gemma_outlier_df %>%
  filter(Age_Category == AgeCategory)
  #Mass Normal Distribution for each Age
  v <- ggplot(mapping = aes(sample =Group_df$Length_mm)) + stat_qq_point(size = 2) +
    stat_qq_line(color = "green") + xlab("Normal N(0,1) Order Statistic Medians") +
    ylab("Ordered Response") + labs(title = paste("Gemma Length Normal Probabilty Plot: ", AgeCategory))
  print(v)
  }

#same for Mysis
for (AgeCategory in levels(growth_mysis_outlier_df$Age_Category)){
  Group_df <- growth_mysis_outlier_df %>%
  filter(Age_Category == AgeCategory)
  #Mass Normal Distribution for each Age
  v <- ggplot(mapping = aes(sample =Group_df$Length_mm)) + stat_qq_point(size = 2) +
    stat_qq_line(color = "green") + xlab("Normal N(0,1) Order Statistic Medians") +
    ylab("Ordered Response") + labs(title = paste("Mysis Length Normal Probabilty Plot: ", AgeCategory))
  print(v)
  }


```
Although the outliers are causing our distribution to skew, because we have over 
50 samples per age per group, we will use the CLT to assume normality. 



## Mass Boxplot Outliers
Lets take a look at our outliers from the previous analysis

```{r Mass Outliers Boxplots}
#descriptive statistics
growth_gemma_outlier_df <- df_growth %>% filter(Feed_Group == "Gemma")

growth_mysis_outlier_df <- df_growth %>% filter(Feed_Group == "Mysis")

summary(growth_mysis_outlier_df$Mass_mg)


#Find boxplot statistics. First we need to summarize a list from groups
growth_gemma_outlier_df %>%
  group_by(Age_Category) %>%
  summarize(boxplot = list(setNames(boxplot.stats(Mass_mg)$stats, 
                                    c('lower_whisker','lower quartile',
                                      'median','upper quartile','upper whisker')))) %>%
#using tidyr unnest_wider function we can pull out the stats information
  unnest_wider(boxplot)


#Find boxplot statistics. First we need to summarize a list from groups
growth_mysis_outlier_df %>%
  group_by(Age_Category) %>%
  summarize(boxplot = list(setNames(boxplot.stats(Mass_mg)$stats, 
                                    c('lower_whisker','lower quartile',
                                      'median','upper quartile','upper whisker')))) %>%
  unnest_wider(boxplot)


#Find outliers from earlier using stats. First we need to summarize a list from groups
gemma_outliers <- growth_gemma_outlier_df %>%
  group_by(Age_Category) %>%
  summarize(boxplot =boxplot.stats(Mass_mg)$out) %>%
  unnest_wider(boxplot)

#Find outliers from earlier using stats. First we need to summarize a list from groups
mysis_outliers <- growth_mysis_outlier_df %>%
  group_by(Age_Category) %>%
  summarize(boxplot = boxplot.stats(Mass_mg)$out) %>%
  unnest_wider(boxplot)


#Now that we know there are outliers, lets grab a dataframe from each of them.
#Using the previous work, we can add the which() function to tell us where these
#outliers live and then filter our dataset around that.

#Finding outliers by value without filtering for age, causes issues where
#an outlier for a certain age is not an outlier elsewhere but is chosen elsewhere 
#because it has the same value (e.g. 2337 @ Five Months and Twelve Months)


gemma_outlier_loc <- which(growth_gemma_outlier_df$Mass_mg %in% c(gemma_outliers$...1))

gemma_mass_outlier_df <- growth_gemma_outlier_df[gemma_outlier_loc,]


mysis_outlier_loc <- which(growth_mysis_outlier_df$Mass_mg %in% c(mysis_outliers$...1))

mysis_mass_outlier_df <- growth_mysis_outlier_df[mysis_outlier_loc,]

```

# Mass Percentile Outliers
Percentile outliers will flag any sample outside 2.5 and 97.5 percentiles. 

```{r Mass Outliers Percentiles}

#For each age category we will find the 2.5% bound  using the qunatile() func.
lower_bound_gemma <- growth_gemma_outlier_df %>%
  group_by(Age_Category) %>%
  summarize(quantile(Mass_mg, 0.025))


#For each age category we will find the 97.5% bound  using the qunatile() func.
upper_bound_gemma <- growth_gemma_outlier_df %>%
  group_by(Age_Category) %>%
  summarize(quantile(Mass_mg, 0.975))

#For each age category we will find the 2.5% bound  using the qunatile() func.
lower_bound_mysis <- growth_gemma_outlier_df %>%
  group_by(Age_Category) %>%
  summarize(quantile(Mass_mg, 0.025))

#For each age category we will find the 97.5% bound  using the qunatile() func.
upper_bound_mysis <- growth_gemma_outlier_df %>%
  group_by(Age_Category) %>%
  summarize(quantile(Mass_mg, 0.975))


#percentile df of the outliers
mass_gemma_percentile_df <- data.frame()
for (AgeCategory in levels(growth_gemma_outlier_df$Age_Category)){
  #iterate through all age categories filtering any values outside the category's bounds
  temp_df <- growth_gemma_outlier_df %>%
    filter(Age_Category == AgeCategory) %>%
    filter(Mass_mg < lower_bound_gemma$`quantile(Mass_mg, 0.025)`[lower_bound_gemma$Age_Category==AgeCategory] | 
           Mass_mg > upper_bound_gemma$`quantile(Mass_mg, 0.975)`[upper_bound_gemma$Age_Category==AgeCategory])
  mass_gemma_percentile_df <-rbind(mass_gemma_percentile_df,temp_df)
  }
  

mass_mysis_percentile_df <- data.frame()
for (AgeCategory in levels(growth_mysis_outlier_df$Age_Category)){
  #iterate through all age categories filtering any values outside the category's bounds
    temp_df_mysis <- growth_mysis_outlier_df %>%
    filter(Age_Category == AgeCategory) %>%
    filter(Mass_mg < lower_bound_mysis$`quantile(Mass_mg, 0.025)`[lower_bound_mysis$Age_Category==AgeCategory] | 
           Mass_mg > upper_bound_mysis$`quantile(Mass_mg, 0.975)`[upper_bound_mysis$Age_Category==AgeCategory])
  mass_mysis_percentile_df <-rbind(mass_mysis_percentile_df,temp_df_mysis)
  }
  

```

## Mass Generalized ESD Test for Outliers
Generalized ESD test is used to detect one or more outliers in a univariate dataset
for approximate normal distribution. We do not have to specify the number of outliers, just an upper bound.

```{r Rosner's GESD Test for Mass Outliers}
#Create empty dataframe
mass_gemma_rosner_df <- data.frame()
#iterate through age categories and create temp df for that age category
for (AgeCategory in levels(growth_gemma_outlier_df$Age_Category)){
  Group_df <- growth_gemma_outlier_df %>%
  filter(Age_Category == AgeCategory)

  #use rosner test function to find outliers (max 10) for each age category 
  
  gemma_rosner_mass <- rosnerTest(Group_df$Mass_mg,k=10, alpha = 0.05)
  #create temp df where only outliers exist
  temp_df <- gemma_rosner_mass[["all.stats"]] %>%
    filter(Outlier == TRUE)
  #filter the age df based on the observation row number provided
  gemma_rosner_outlier_loc <- Group_df %>% filter(row_number() %in% temp_df$Obs.Num)
  #append to new df
  mass_gemma_rosner_df <-rbind(mass_gemma_rosner_df,gemma_rosner_outlier_loc)
}

#Create empty dataframe
mass_mysis_rosner_df <- data.frame()
#iterate through age categories and create temp df for that age category
for (AgeCategory in levels(growth_mysis_outlier_df$Age_Category)){
  Group_df <- growth_mysis_outlier_df %>%
  filter(Age_Category == AgeCategory)

  #use rosner test function to find outliers (max 10) for each age category 
  
  mysis_rosner_mass <- rosnerTest(Group_df$Mass_mg,k=10, alpha = 0.05)
  #create temp df where only outliers exist
  temp_df <- mysis_rosner_mass[["all.stats"]] %>%
    filter(Outlier == TRUE)
  #filter the age df based on the observation row number provided
  mysis_rosner_outlier_loc <- Group_df %>% filter(row_number() %in% temp_df$Obs.Num)
  #append to new df
  mass_mysis_rosner_df <-rbind(mass_mysis_rosner_df,mysis_rosner_outlier_loc)
}


```


#Mass Cooks Distance Outliers
This wonderful outlier detection method estimates the amount of influence each 
observation has on the over all regression model. It does this by removing each 
observation and calculating the change in the model. A general rule is outliers
are 3x the mean of all the distances. Because it's based on regression model,
only the X variable has impact on the outcome, which allows us to see the amount
of influce a sample has on the predicted outcome. The measurement is the change in Y
for all observations with and without the sample.

```{r Cooks Distance Outliers}
for (AgeCategory in levels(growth_mysis_outlier_df$Age_Category)){
  Group_df <- growth_mysis_outlier_df %>%
  filter(Age_Category == AgeCategory)

#create linear regression model for Mass. We will use the Log of Mass and  Length
  #we use the log based on previous information telling us length-mass is not a 
  #strictly linear relationship
  model <- lm(Mass_mg ~ Length_mm, data = Group_df)
  summary(model)
  
#look at diagnostic plots for outliers
  par(mfrow = c(2,2))
  plot(model)

  #based on the residual vs leverage models, we can see some outliers have large 
  #impact on our models
  
  #looking at cooks distance. picking out any observations that are 3x the mean of cooksD
 cooksD <- cooks.distance(model)
 influencial <- cooksD[(cooksD > (3 * mean(cooksD, na.rm =TRUE)))]
 
 plot(cooksD, pch="*", cex=2, main = "Influential Obs by Cooks distance") #plot cooks distance
 abline(h = 3 * mean(cooksD, na.rm =TRUE),col="red") # add cutoff line
 text(x=1:length(cooksD)+1, y=cooksD, labels =ifelse(cooksD>3 * mean(cooksD, na.rm =TRUE),names(cooksD),""),col="red") #add labels
 
}

```
```{r Most Extreme Outlier of Each Group}
#finds the largest difference from the mean

for (AgeCategory in levels(growth_mysis_outlier_df$Age_Category)){
  Group_df <- growth_mysis_outlier_df %>%
  filter(Age_Category == AgeCategory)
  print(grubbs.test(Group_df$Mass_mg,type=11)) 
}

for (AgeCategory in levels(growth_gemma_outlier_df$Age_Category)){
  Group_df <- growth_gemma_outlier_df %>%
  filter(Age_Category == AgeCategory)
  print(grubbs.test(Group_df$Mass_mg,type=11)) 
}
```




## Length Boxplot Outliers


```{r Length Outlier Boxplot}

summary(growth_mysis_outlier_df$Length_mm)
summary(growth_gemma_outlier_df$Length_mm)

#Find boxplot statistics. First we need to summarize a list from groups
Length_Gemma_Stats <- growth_gemma_outlier_df %>%
  group_by(Age_Category) %>%
  summarize(boxplot = list(setNames(boxplot.stats(Length_mm)$stats, 
                                    c('lower_whisker','lower quartile',
                                      'median','upper quartile','upper whisker')))) %>%
  
#using tidyr unnest_wider function we can pull out the stats information

  unnest_wider(boxplot)

#Find boxplot statistics. First we need to summarize a list from groups
Length_Mysis_Stats <- growth_mysis_outlier_df %>%
  group_by(Age_Category) %>%
  summarize(boxplot = list(setNames(boxplot.stats(Length_mm)$stats, 
                                    c('lower_whisker','lower quartile',
                                      'median','upper quartile','upper whisker')))) %>%
  
#using tidyr unnest_wider function we can pull out the stats information

  unnest_wider(boxplot)




#Find outliers from earlier using stats. First we need to summarize a list from groups
gemma_outliers_length <- growth_gemma_outlier_df %>%
  group_by(Age_Category) %>%
  summarize(boxplot =boxplot.stats(Length_mm)$out) %>%
  
#using tidyr unnest_wider function we can pull out the stats information

  unnest_wider(boxplot)

#Find outliers from earlier using stats. First we need to summarize a list from groups
mysis_outliers_length <- growth_mysis_outlier_df %>%
  group_by(Age_Category) %>%
  summarize(boxplot = boxplot.stats(Length_mm)$out) %>%
  
#using tidyr unnest_wider function we can pull out the stats information

  unnest_wider(boxplot)


#Now that we know there are outliers, lets grab a dataframe from each of them.
#Using the previous work, we can add the which() function to tell us where these
#outliers live and then filter our dataset around that.

gemma_length_outlier_loc <- which(growth_gemma_outlier_df$Length_mm %in% c(gemma_outliers_length$...1))

gemma_length_outlier_df <- growth_gemma_outlier_df[gemma_length_outlier_loc,]


mysis_length_outlier_loc <- which(growth_mysis_outlier_df$Length_mm %in% c(mysis_outliers_length$...1))

mysis_length_outlier_df <- growth_mysis_outlier_df[mysis_length_outlier_loc,]


```



## Summarize Outlier Testing
Now that we have an understanding of different methods for outlier collection,
I was curious how similar these methods would be. Which outliers would recieve marks 
from the most methods for detection? Which would only mark one. Do the Mass outliers
correspond to the Length Outliers?

```{r Summary of Oultiers}

# We have made Boxplots, percentile, Rosner, Cooks Distance, and Grubbs. 




```



## Linear Model
Based on our outlier plots, we can be pretty certain a linear model is not appropriate
for our models. However,we will use the Residual plot to help us understand. Using these
plots its pretty clear a polynomial model is more appropriate. 


```{r Residuals}
y <- df_growth$Mass_mg
x <- df_growth$Length_mm

mod <- lm(y~x)

#Plot the residuals for a linear model. 
resid_panel(mod, plots='resid')


#Log transform both Mass and Length to compare a log transformed model against
#the original model
df_growth$Mass_log <- log(df_growth$Mass_mg)
df_growth$Length_log <- log(df_growth$Length_mm)
y2 <- df_growth$Mass_log
x2 <- df_growth$Length_log

mod_log <- lm(y2~x2)

#Compare the linear model to a log transformed model 
resid_compare(models=list(mod,
                          mod_log),
              plots= c("resid", "qq"),
              smoother = TRUE,
              qqbands = TRUE,
              title.opt = FALSE)

#This log tranformed residuals indicates that this  is a power function. 

#The plot shows us a linear model is not appropriate, so we will use a 2nd order
#polynomial 
#Growth Curves of Gemma and Mysis Mass vs Length
ggplot(df_growth, aes(x = Length_mm, y = Mass_mg, color = Feed_Group))+geom_point()+
  geom_smooth(method='lm',formula = y~poly(x,2,raw=TRUE),se=TRUE)

```

