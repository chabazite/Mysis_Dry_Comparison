---
title: "Mysis_Dry_Compare"
author: "Andrew Ingalls"
date: "1/1/2022"
output: html_document
---
#Mysis vs. Dry Feed Comparison Study


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(openxlsx)
library(tidyverse)
library(lsmeans)
library(plotly)
library(outliers)
library(ggridges)
library(viridis)
library(hrbrthemes)
library(ggResidpanel)

```

## Data Cleaning
These data have some unecessary columns, some poorly titled columns, 
as well as some categories that are not standardize over the time of the project. 
This section will be the cleaning stage of the project

```{r Data_Cleaning, include=TRUE}

df_growth<-read.xlsx("../data/Mysis_Pilot.xlsx", 
                     sheet="Exp_1",detectDates=T)
df_survival<-read.xlsx("../data/Mysis_Pilot.xlsx", 
                       sheet="Survival Census (Progress)",detectDates=T)
df_sex_sort <-read.xlsx("../data/Mysis_Pilot.xlsx", 
                        sheet="Sexing",detectDates=T)

head(df_growth)
head(df_survival)
head(df_sex_sort)

summary(df_growth)
summary(df_survival)
summary(df_sex_sort)

#df_Growth Cleanup
#Remove unneeded columns from df_growth such as Time
#Remove 'age' because samples were taken over the course of 3 days, 
#which is why age-category was added
df_growth <- subset(df_growth,select=-c(Time, Age,Possible.Outliers)) 

#rename columns for ease of use
colnames(df_growth) <- c("Date", "Tank", "Age_Category","Feed_Group",
                         "Length_mm","Mass_mg","Condition_Factor")

#changes types and create factors where needed
cols <- c("Tank", "Age_Category","Feed_Group")
df_growth[cols] <- lapply(df_growth[cols], factor)

#check
sapply(df_growth,class)

#reorder age and age category factor levels
df_growth$Age_Category <- factor(df_growth$Age_Category, 
                                 levels = c("Three Months", "Five Months",
                                             "Six Months", "Eight Months", 
                                             "Nine Months","Twelve Months"))

#Check for NAs
df_growth[!complete.cases(df_growth),]

#standardize tank location
old_tank_list <-  c("7.C.4","7.C.5","7.C.6","7.C.7","7.C.8","7.C.9",
                    "7.C.10","7.C.11")
old_tank_list_2nd <- c("7.B.3-4","7.C.3-4","7.C.1-2","7.C.5-6","7.C.7-8",
                       "7.C.9-10","7.E.9-10","7.C.11-12")
new_tank_list <-  c("7.E.3-4","7.E.1-2","7.D.7-8","7.E.11-12","7.D.1-2",
                    "7.D.3-4","7.E.9-10","7.D.5-6")

#batch change the tank locations based on the lists above which was the first 
#mass move of tanks (readme.md)
df_growth <- df_growth %>%
  mutate(Tank = recode(Tank, !!!setNames(new_tank_list, old_tank_list)))

#batch change again for the second mass move of tanks(readme.md)
df_growth <- df_growth %>%
  mutate(Tank = recode(Tank, !!!setNames(new_tank_list, old_tank_list_2nd)))

#Check to make sure we only have 8 tank levels
summary(df_growth)
levels(df_growth$Tank)



#Clean up df_survival

#Remove columns that were just interm calculations in excel. Not needed
df_survival <- subset(df_survival,select=-c(Lost,Total,Male,Female,Unknown)) 

#rename columns for consistency
colnames(df_survival) <- c("Date", "Tank","Feed_Group", "Census")

#batch change the tank locations based on the lists above which was the 
#first mass move of tanks (readme.md)
df_survival <- df_survival %>%
  mutate(Tank = recode(Tank, !!!setNames(new_tank_list, old_tank_list)))

#batch change again for the second mass move of tanks(readme.md)
df_survival <- df_survival %>%
  mutate(Tank = recode(Tank, !!!setNames(new_tank_list, old_tank_list_2nd)))

#Change Tank and Group into Factors
df_survival$Tank <- factor(df_survival$Tank) 
df_survival$Feed_Group <- factor(df_survival$Feed_Group)



#Cleanup Sex_sort data

#remove time column
df_sex_sort <- subset(df_sex_sort, select = -Time)

#Factor Tank and Group
df_sex_sort$Tank <- factor(df_sex_sort$Tank)
df_sex_sort$Group <- factor(df_sex_sort$Group)


#Check all changes using head() summary() and levels()
```

## Exploritory Data Analysis for Growth

Here we will focus on our Growth data. Do we see a normal distribution of data?
Is there a correlation between mass and length?
Condition Factor is a method for showing the health of a fish (similar to BMI)
Do we see condition factor change with age? Any other parameters change with age?
What do we see for outliers? Can these be removed or are they true?
What do our residuals look like, can we use linear regression to explain this?
What does the confidence interval look like for both Feed Groups?
Are we seeing any significant difference between the Feed Groups in the variables?


```{r pressure, echo=FALSE}

#histogram for Mass (Right skewed)
ggplot(df_growth, aes(x=Mass_mg))+geom_histogram(aes(y=..density..))+
  geom_vline(aes(xintercept=mean(Mass_mg)), color="blue", linetype="dashed",size=1)+
  geom_density(alpha=0.2,fill="#FF6666")+
  theme_bw()

#histogram for Length (double peak)
ggplot(df_growth, aes(x=Length_mm))+geom_histogram(aes(y=..density..))+
  geom_vline(aes(xintercept=mean(Length_mm)), color="blue", linetype="dashed",size=1)+
  geom_density(alpha=0.2,fill="#FF6666")+
  theme_bw()


#Histogram by Groups

#MASS
ggplot(df_growth, aes(x=Mass_mg, color=Feed_Group))+geom_histogram(aes(y=..density..),fill='white',alpha=0.5)+
  geom_vline(aes(xintercept=mean(Mass_mg)), color="blue", linetype="dashed",size=1)+
  geom_density(alpha=0.2,fill="#FF6666")+
  theme_bw()+scale_color_brewer(palette="Dark2")
#Length
ggplot(df_growth, aes(x=Length_mm, color=Feed_Group))+geom_histogram(aes(y=..density..),fill="white",alpha=0.5)+
  geom_vline(aes(xintercept=mean(Length_mm)), color="blue", linetype="dashed",size=1)+
  geom_density(alpha=0.2,fill="#FF6666")+
  theme_bw()+scale_color_brewer(palette="Dark2")
#Histogram Plot of Mass for Ages and Groups
ggplot(df_growth, aes(x=Mass_mg, color=Feed_Group))+geom_density(alpha=0.2,fill='grey') + 
  facet_wrap(~Age_Category)

#Histogram Plot of Length for Ages and Groups
ggplot(df_growth, aes(x=Length_mm, color=Feed_Group))+geom_density(alpha=0.2,fill='grey') + 
  facet_wrap(~Age_Category)

ggplot(df_growth, aes(x=Length_mm,y=Age_Category, fill=..x..))+
  geom_density_ridges_gradient(scale=3, rel_min_height=0.01)+
  scale_fill_viridis(name="Length_mm",option="C")+
  labs(title='Mass of Surface Morph by Age')+
  theme_ipsum()+
  theme(
    legend.position = 'none',
    panel.spacing = unit(0.1,'lines'),
    strip.text.x = element_text(size=8)
  ) +
  facet_wrap(~Feed_Group,ncol=1)

ggplot(df_growth, aes(x=Mass_mg,y=Age_Category, fill=..x..))+
  geom_density_ridges_gradient(scale=3, rel_min_height=0.01)+
  scale_fill_viridis(name="Mass_mg",option="C")+
  labs(title='Mass of Surface Morph by Age')+
  theme_ipsum()+
  theme(
    legend.position = 'none',
    panel.spacing = unit(0.1,'lines'),
    strip.text.x = element_text(size=8)
  ) +
  facet_wrap(~Feed_Group,ncol=1)


#Box plot of Mass vs Age for Groups

ggplot(df_growth,aes(y=Mass_mg, x=Age_Category,fill=Feed_Group)) + geom_boxplot(outlier.color='red',outlier.shape=1)

#Box plot of Length vs Age for Groups

ggplot(df_growth,aes(y=Length_mm, x=Age_Category,fill=Feed_Group)) + geom_boxplot(outlier.color='red',outlier.shape=1)

#Violin plot
ggplot(df_growth,aes(y=Mass_mg, x=Age_Category,fill=Feed_Group)) + geom_violin()+stat_summary(fun=median,geom='point',size=2,color='red')+
  facet_wrap(~Feed_Group)+theme_bw()+theme(axis.text.x=element_text(angle=45,hjust=1))

ggplot(df_growth,aes(y=Length_mm, x=Age_Category,fill=Feed_Group)) + geom_violin()+stat_summary(fun=median,geom='point',size=2,color='red')+
  facet_wrap(~Feed_Group)+theme_bw()+theme(axis.text.x=element_text(angle=45,hjust=1))

#Understanding growth based on Age category
ggplot(df_growth, aes(y=Age_Category,x=Mass_mg, color=Feed_Group))+geom_point(alpha=0.5)
ggplot(df_growth, aes(y=Age_Category,x=Length_mm, color=Feed_Group))+geom_point(alpha=0.5)


```
We need to understand if a linear model if acceptable for Mass vs Length, or a 
polynomial. We will use the Residual plot to help us understand.


```{r Residuals}
y <- df_growth$Mass_mg
x <- df_growth$Length_mm

mod <- lm(y~x)

#Plot the residuals for a linear model. 
resid_panel(mod, plots='resid')


#Log transform both Mass and Length to compare a log transformed model against
#the original model
df_growth$Mass_log <- log(df_growth$Mass_mg)
df_growth$Length_log <- log(df_growth$Length_mm)
y2 <- df_growth$Mass_log
x2 <- df_growth$Length_log

mod_log <- lm(y2~x2)

#Compare the linear model to a log transformed model 
resid_compare(models=list(mod,
                          mod_log),
              plots= c("resid", "qq"),
              smoother = TRUE,
              qqbands = TRUE,
              title.opt = FALSE)

#This log tranformed residuals indicates that this  is a power function. 

#The plot shows us a linear model is not appropriate, so we will use a 2nd order
#polynomial 
#Growth Curves of Gemma and Mysis Mass vs Length
ggplot(df_growth, aes(x = Length_mm, y = Mass_mg, color = Feed_Group))+geom_point()+
  geom_smooth(method='lm',formula = y~poly(x,2,raw=TRUE),se=TRUE)

```

