---
title: "4.0 Modeling"
author: "Andrew Ingalls"
date: "3/29/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(ggridges)
library(viridis) #coloring for ridge plots
library(ggResidpanel) # panel of diagnostic plots including cooksd
library(qqplotr) #qq plots
library(rstatix) #t-test, wilcoxon, anova, kruskal-wallis, correlation, levenetest,
library(broom) #output tibbles for statistical modeling 
library(ggpubr) #publication ready plots
library(ragg) #help with png creation
library(gridExtra) #allows for grid.arrange functionality
library(WRS2) #collection of robust statistical methods based on Wilcox;
library(emmeans) #pairwise

```

# Growth

## Mass Significance Testing by Age for Feed Groups
Because we don't have strictly normal distributions for our data, I won't be using
any tests that assume normality. To confirm our intuitions about a lack of significant
difference in growth between the Feed Groups, we will have to test the 
null hypothesis (p-value < 0.05). Our null hypothesis is: There is no difference in Mass
between the Feed Group for each Age group. 

First we will take a look at the variances between the populations. This will
help us further understand what type of significance test to perform.

Since we aren't confident in normality of our test, we will use the Levene's test
to test the variance. 

For Significance, we are curious if either of the Feed Groups has a superior performance,
so we will use a two-tailed test.

```{r Boxplot Significance Testing}
#Variance for Mass for Age Groups between Feed Groups are not Significantly Different
df_growth %>%
  group_by(Age_Category)%>%
  levene_test(Mass_mg ~ Feed_Group)

#Two Sample unpaired nonparametric test. iterate over all age categories
Wilcox_Mass_Age_P_Table <- data.frame(matrix(nrow=0, ncol = 2))
colnames(Wilcox_Mass_Age_P_Table) <-c('Age Category','P-Value')

for (AgeCategory in levels(df_growth$Age_Category)){
  Mysis_Age_df_filter <- df_growth%>% 
                            filter(., Age_Category == AgeCategory & 
                                      df_growth$Feed_Group == 'Mysis')
  Gemma_Age_df_filter <- df_growth %>% 
                            filter(., Age_Category == AgeCategory &
                                      df_growth$Feed_Group == 'Gemma')
  
  SigTest <- wilcox.test(Mysis_Age_df_filter$Mass_mg, Gemma_Age_df_filter$Mass_mg, 
                         alternative = "two.sided", paired =FALSE)
  
  #add new significance data one row below previous
  Wilcox_Mass_Age_P_Table[nrow(Wilcox_Mass_Age_P_Table) + 1,] <- c(AgeCategory, 
                                                                   SigTest$p.value)
}
#No significant difference between the Feed Groups for any Age Category

Mass_boxplot <- ggboxplot(df_growth, x="Age_Category", y="Mass_mg",
              color = "Feed_Group", 
              add = "jitter")

Mass_P_Graph <- Mass_boxplot + 
    stat_compare_means(aes(group = Feed_Group), label = "p.format", size = 7) + 
  scale_color_brewer(palette="Dark2") +
  labs(title='Mass of A. mexicanus by Age & Feed Type', 
       subtitle = "Wilcoxon Rank Sum Test",
       y = "Mass (mg)", x = "Age Category") +
  theme_specs


```

## Length Significance Testing by Age for Feed Groups

```{r}
#Variance for Length for Age Groups between Feed Groups are only significantly different for three months
df_growth %>%
  group_by(Age_Category)%>%
  levene_test(Length_mm ~ Feed_Group)

#Two Sample unpaired nonparametric test. iterate over all age categories
Wilcox_Length_Age_P_Table <- data.frame(matrix(nrow=0, ncol = 2))
colnames(Wilcox_Length_Age_P_Table) <-c('Age Category','P-Value')

#No significant difference between the Feed Groups for any Age Category
for (AgeCategory in levels(df_growth$Age_Category)){
  Mysis_Age_df_filter <- df_growth%>% 
                            filter(., Age_Category == AgeCategory & 
                                      df_growth$Feed_Group == 'Mysis')
  Gemma_Age_df_filter <- df_growth %>% 
                            filter(., Age_Category == AgeCategory &
                                      df_growth$Feed_Group == 'Gemma')
  
  SigTest <- wilcox.test(Mysis_Age_df_filter$Length_mm, Gemma_Age_df_filter$Length_mm, 
                         alternative = "two.sided", 
                         paired= FALSE)
  
  Wilcox_Length_Age_P_Table[nrow(Wilcox_Length_Age_P_Table) + 1,] <- c(AgeCategory, 
                                                                       SigTest$p.value)
  
}

Length_box_plot <- ggboxplot(df_growth, x="Age_Category", y="Length_mm",
              color = "Feed_Group", 
              add = "jitter",lwd=2, 
                             fill='grey', 
                             outlier.colour = NULL, 
                             outlier.size = 3) 

Length_P_Graph <- Length_box_plot + 
  stat_compare_means(aes(group = Feed_Group), label = "p.format", size = 7) + 
  scale_color_brewer(palette="Dark2") +
  labs(title='Length of A. mexicanus by Age & Feed Type', 
       subtitle = "Wilcoxon Rank Sum Test",
       y = "Length (mm)", x = "Age Category") +
  theme_specs
    



Wilcox_Length_Age_P_Table

```

## Length-Mass Relationship Modeling for Feed Groups 
Based on our distribution plots, we can be pretty certain a linear model is not appropriate
for our models. However, we will use the Residual plot to help us understand our model better.
Using these plots its pretty clear a polynomial model is more appropriate. 

This is important in the husbandry of fish as this relationship gives us the growth of the fish,
its health, and a realative condition within its life.

```{r Residual Plots}
y <- df_growth$Mass_mg
x <- df_growth$Length_mm

mod <- lm(y~x)

resid_panel(mod, plots='resid')

```

```{r Transform Data for Linear Regression}
df_growth$Mass_log <- log(df_growth$Mass_mg)
df_growth$Length_log <- log(df_growth$Length_mm)
y2 <- df_growth$Mass_log
x2 <- df_growth$Length_log

mod_log <- lm(y2~x2)


#still not normally distributed
shapiro.test(resid(mod_log))

#Compare the linear model to a log transformed model 
resid_compare(models=list(mod,
                          mod_log),
              plots= c("resid", "qq"),
              smoother = TRUE,
              qqbands = TRUE,
              title.opt = FALSE)
#Log transform data looks like a great fit


by_feedgroups <- group_by( df_growth, Feed_Group)

do(by_feedgroups,tidy(lm(Mass_log~Length_log,data=.)))


model_FeedGroups <- lm(Mass_log~Length_log*Feed_Group, df_growth)

summary(model_FeedGroups)

glance(model_FeedGroups)


plot(df_growth$Length_log, df_growth$Mass_log, col='red', main='Summary of Regression Model', xlab='x', ylab='y')


#The model is statistically significant, however the groups are not. Very tight R2

summary(aov(Mass_log ~ Length_log*Feed_Group, data=df_growth))

```

```{r Correlation and Plotting of Each Feed Group}

#Spearman Correlation, which does not require normality
df_growth_mysis <- df_growth %>%
  filter(.,Feed_Group=="Mysis")  
cor(df_growth_mysis$Length_mm,df_growth_mysis$Mass_mg, method="spearman")

df_growth_gemma <- df_growth %>%
  filter(.,Feed_Group=="Gemma")  
cor(df_growth_gemma$Length_mm,df_growth_gemma$Mass_mg, method="spearman")

#Visual representation of spearman correlation  
ggscatter(df_growth_mysis, x='Length_log', y='Mass_log', add = "reg.line", conf.int=TRUE, 
          cor.coef = TRUE, cor.method = "spearman", xlab = "Length (mm)", ylab = "Mass (mg)",
          title = "Mysis: Length Mass Log Relationship")

ggscatter(df_growth_gemma, x='Length_log', y='Mass_log', add = "reg.line", conf.int=TRUE, 
          cor.coef = TRUE, cor.method = "spearman", xlab = "Length (mm)", ylab = "Mass (mg)",
          title = "Gemma: Length Mass Log Relationship")


#Create linear model for each feed group using log transformations.
mysis_linear_model <- lm(Mass_log~Length_log,data=df_growth_mysis)
gemma_linear_model <- lm(Mass_log~Length_log,data=df_growth_gemma) 

#Residuals % Q-Q plots
plot(mysis_linear_model)
plot(gemma_linear_model)

```

```{r Plot Feed Groups with poly and linear line for visualization}

#both plots appear to not be significantly different from one another
ggplot(df_growth, aes(x = Length_mm, y = Mass_mg, color = Feed_Group)) +
  geom_point() +
  geom_smooth(method='lm',formula = y~poly(x,2,raw=TRUE),se=FALSE)

ggplot(df_growth, aes(x = Length_log, y = Mass_log, color = Feed_Group)) +
  geom_point() +
  geom_smooth()


#CHECK Assumptions before ANCOVA

#Linear Relationship Assumption
ggscatter(
  df_growth, x = 'Length_log' , y =  'Mass_log',
  color = "Feed_Group", add = "reg.line"
  )+
  stat_regline_equation(
    aes(label =  paste(..eq.label.., ..rr.label.., sep = "~~~~"), color = Feed_Group)
    )

#Homogeneity of regression slopes 
#Feed_Group interaction was not statisticaly significant F(1,730) = 0.390 p = 0.533
df_growth %>% anova_test(Mass_log ~ Feed_Group*Length_log)


#Normality of Residuals
feed_model <-  lm(Mass_log ~ Length_log + Feed_Group, data =df_growth)
feed_model.metrics <- augment(feed_model) %>%
  select(-.hat,-.sigma,-.fitted) #remove unneeded details

head(feed_model.metrics,3)

shapiro_test(feed_model.metrics$.resid)

#failed shapiro test


#Wilcox ancova to compare two linear regression lines
#only significantly different on the extreme ends of the regression model

ancova(Mass_log ~ Length_log + Feed_Group, df_growth)



#even though we didn't pass all assumptions for regular anova, i still ran it to see
res.aov <- df_growth %>% anova_test(Mass_log ~ Length_log + Feed_Group)

get_anova_table(res.aov)

#no signficance between groups

#Pairwise #no significance between means of groups

pwc <- df_growth %>%
  emmeans_test(
    Mass_log ~ Feed_Group, covariate = Length_log,
    p.adjust.method = "bonferroni"
  )

get_emmeans(pwc)

pwc <- pwc %>% add_xy_position(x = "Feed_Group", fun = "mean_se")
ggline(get_emmeans(pwc), x = "Feed_Group", y = "emmean") +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2) + 
  stat_pvalue_manual(pwc, hide.ns = TRUE, tip.length = FALSE) +
  labs(
    subtitle = get_test_label(res.aov, detailed = TRUE),
    caption = get_pwc_label(pwc)
  )

```


# Survival

## Signficance Testing between Census Events for Census and Deaths

```{r  Survival}

#Summarize data by feedgroup and date, the sum each group date, then plot
df_survival %>%
  group_by(Feed_Group,Date) %>%
  summarise(Census_avg=mean(Census), 
            Standard_Error=sd(Census)/sqrt(length(Census))) %>%
  ggplot(.,aes(x=Date,y=Census_avg,color=Feed_Group)) +geom_line(size=2)+
  geom_point(size = 4)+ geom_errorbar(aes(ymin=Census_avg-Standard_Error,
                                  ymax=Census_avg+Standard_Error),width=5) +
  scale_color_brewer(palette="Dark2") +
  labs(title='Average Feed Group Census over Time', 
       subtitle = 'Standard Error for Comparison',
       y = "Fish Census", x = "Date") 

t_test_census <- data.frame(matrix(nrow=0, ncol = 2))
colnames(t_test_census) <-c('Sample Date','P_Value')

for (Date in levels(factor(df_survival$Date))){
   if (Date == "2020-10-15"){
     next
     }else{
  Mysis_Census <- df_survival$Census[df_survival$Date == Date & 
                         df_survival$Feed_Group == 'Mysis']

  Gemma_Census <- df_survival$Census[df_survival$Date == Date &
                         df_survival$Feed_Group == 'Gemma']
  
  SigTest <- t.test(Mysis_Census, Gemma_Census)
  
  t_test_census[nrow(t_test_census) + 1,] <- c(Date, SigTest$p.value)
     }
}


#difference in deaths
df_survival %>%
  group_by(Date, Feed_Group) %>%
  summarize(Census = mean(Census)) %>%
  group_by(Feed_Group) %>%
  summarize(Census_Dead = -diff(Census),
            Date = Date[-1]) %>%
   ggplot(aes(y = Census_Dead, x= Date)) +
  geom_col(aes(fill = Feed_Group), position = "dodge") +
  scale_color_brewer(palette="Dark2") +
  labs(title='Average Feed Group Deaths between Census Events', 
       y = "Fish Deaths", x = "Date")


#Deaths

df_deaths <- df_survival %>%
  group_by(Tank_Location, Feed_Group) %>%
  summarize(Census_Dead = -diff(Census),
            Date = Date[-1])


t_test_deaths <- data.frame(matrix(nrow=0, ncol = 2))
colnames(t_test_deaths) <-c('Sample Date','P_Value')

for (Date in levels(factor(df_deaths$Date))){

  Mysis_death <- df_deaths$Census_Dead[df_deaths$Date == Date & 
                         df_deaths$Feed_Group == 'Mysis']

  Gemma_death <- df_deaths$Census_Dead[df_deaths$Date == Date &
                         df_deaths$Feed_Group == 'Gemma']
  
  SigTest <- t.test(Mysis_death, Gemma_death)
  
  t_test_deaths[nrow(t_test_deaths) + 1,] <- c(Date, SigTest$p.value)
     }






#Summary indicates that Mysis and Gemma have similar intercepts 244.68,538.6,but gemma is higher which 
#makes sense given their starting numbers were the same, but their slopes are different, eventually
#Gemma will trace back at a higher y-intercept than Mysis.  R  squared is low, because this doesn't seem linear

ggscatter(df_survival, x="Date", y="Census", color= "Feed_Group", add="reg.line")+
  stat_regline_equation(aes(label = paste(..eq.label..,..rr.label..,sep="~~~~"), color=Feed_Group))


#We are going to test the normality of residuals. 
model.metrics <- augment(mod2) %>%
subset(.,select=c(-.hat,-.sigma,-.fitted))

#shapiro wilk test if not significant (our case) tells us we can assume normality
shapiro_test(model.metrics$.resid)

#now we figure equality of variance of the residuals using Leven's test for ANCOVA
model.metrics %>% levene_test(.resid ~ Feed_Group) #this is also not significant

#look at outliers for the dataset

#Looking for standardized residuals greater than 3 in absolute value. Because we don't 
#see any we can assume no outliers. 
model.metrics %>%
  filter(abs(.std.resid) > 3) %>%
  as.data.frame()

res.aov <- df_survival %>% anova_test(Census~Date+Feed_Group) 

get_anova_table(res.aov)

#pairwise comparisons
pwc<-df_survival %>%
  emmeans_test(
    Census~Feed_Group, covariate=Date,
    p.adjust.method = "bonferroni")
  get_emmeans(pwc)
  
#Line_Plot
pwc <- pwc %>% add_xy_position(x = "Feed_Group", fun = "mean_se")

ggline(get_emmeans(pwc), x = "Feed_Group", y = "emmean") +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2) + 
  stat_pvalue_manual(pwc, hide.ns = TRUE, tip.length = FALSE) +
  labs(
    subtitle = get_test_label(res.aov, detailed = TRUE),
    caption = get_pwc_label(pwc)
  )


#ANOVA on final set
ANOVA_df <- df_survival %>%
  filter(.,Date=='2021-07-06')

res2.aov <- ANOVA_df %>% anova_test(Census~Feed_Group) 

get_anova_table(res2.aov)  

#Compare the final set of data between groups using Welsh's T Test
t.test(ANOVA_df$Census~ANOVA_df$Feed_Group)
```

# Sex Sort

##Significance Testing between Feed Groups


```{r Sex Sort}

#Welch's T-test
t.test(df_sex_sort$Female~df_sex_sort$Feed_Group)
t.test(df_sex_sort$Male~df_sex_sort$Feed_Group)
t.test(df_sex_sort$Unknown~df_sex_sort$Feed_Group)

#Not seeing any significant differences using ANOVA or Welech Two Sample t-test,
#which confirms what we saw in the percentage comparison earlier
```
# Fecundity

## Significance Testing between Feed Groups

```{r Fecundity}
t.test(Viable_Embryos ~ Feed_Group, data=df_fecundity)
```

#Medium Plots
```{r Medium Plots}

#Growth

pngfile <- fs::path(knitr::fig_path(),  "analysis/EDA_Figures/Sig_Mass.png")
agg_png(pngfile, width = 60, height = 36, units = "cm", res = 300)
plot(Mass_P_Graph)
invisible(dev.off())
knitr::include_graphics(pngfile)


pngfile <- fs::path(knitr::fig_path(),  "analysis/EDA_Figures/Sig_Length.png")
agg_png(pngfile, width = 60, height = 36, units = "cm", res = 300)
plot(Length_P_Graph)
invisible(dev.off())
knitr::include_graphics(pngfile)



```

