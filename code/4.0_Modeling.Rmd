---
title: "4.0 Modeling"
author: "Andrew Ingalls"
date: "3/29/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(ggridges)
library(viridis) #coloring for ridge plots
library(ggResidpanel) # panel of diagnostic plots including cooksd
library(qqplotr) #qq plots
#library(EnvStats)
#library(lsmeans)
#library(plotly)
#library(outliers)
#library(hrbrthemes)
library(rstatix) #t-test, wilcoxon, anova, kruskal-wallis, correlation, levenetest
#library(janitor)
#library(broom) #output tibbles for statistical modeling 
#library(datarium) #ANCOVA
library(ggpubr) #publication ready plots
library(ragg) #help with png creation
library(gridExtra) #allows for grid.arrange functionality


```

# Growth

## Mass Significance Testing by Age for Feed Groups
Because we don't have strictly normal distributions for our data, I won't be using
any tests that assume normality. To confirm our intuitions about a lack of significant
difference in growth between the Feed Groups, we will have to test the 
null hypothesis (p-value < 0.05). Our null hypothesis is: There is no difference in Mass
between the Feed Group for each Age group. 

First we will take a look at the variances between the populations. This will
help us further understand what type of significance test to perform.

Since we aren't confident in normality of our test, we will use the Levene's test
to test the variance. 

For Significance, we are curious if either of the Feed Groups has a superior performance,
so we will use a two-tailed test.

```{r Boxplot Significance Testing}
#Variance for Mass for Age Groups between Feed Groups are not Significantly Different
df_growth %>%
  group_by(Age_Category)%>%
  levene_test(Mass_mg ~ Feed_Group)

#Two Sample unpaired nonparametric test. iterate over all age categories
Wilcox_Mass_Age <- data.frame(matrix(nrow=0 ncol = 2))
colnames(Wilcox_Mass_Age) <-c('AgeCategory','P_Value')

#No significant difference between the Feed Groups for any Age Category
for (AgeCategory in levels(df_growth$Age_Category)){
  
  Mysis_Age_Mass <- df_growth$Mass_mg[df_growth$Age_Category == AgeCategory & 
                         df_growth$Feed_Group == 'Mysis']

  Gemma_Age_Mass <- df_growth$Mass_mg[df_growth$Age_Category == AgeCategory &
                         df_growth$Feed_Group == 'Gemma']
  
  SigTest <- wilcox.test(Mysis_Age_Mass, Gemma_Age_Mass, alternative = "two.sided")
  
  Wilcox_Mass_Age[nrow(Wilcox_Mass_Age) + 1,] <- c(AgeCategory,SigTest$p.value)
  
}


Mass_boxplots_AgeandFeed




```




## Length Significance Testing by Age for Feed Groups

```{r}
#Variance for Length for Age Groups between Feed Groups are only significantly different for three months
df_growth %>%
  group_by(Age_Category)%>%
  levene_test(Length_mm ~ Feed_Group)

#Two Sample unpaired nonparametric test. iterate over all age categories
Wilcox_Length_Age <- data.frame(matrix(nrow=0 ncol = 2))
colnames(Wilcox_Length_Age) <-c('AgeCategory','P_Value')

#No significant difference between the Feed Groups for any Age Category
for (AgeCategory in levels(df_growth$Age_Category)){
  
  Mysis_Age_Length <- df_growth$Length_mm[df_growth$Age_Category == AgeCategory & 
                         df_growth$Feed_Group == 'Mysis']

  Gemma_Age_Length <- df_growth$Length_mm[df_growth$Age_Category == AgeCategory &
                         df_growth$Feed_Group == 'Gemma']
  
  SigTest <- wilcox.test(Mysis_Age_Length, Gemma_Age_Length, alternative = "two.sided")
  
  Wilcox_Length_Age[nrow(Wilcox_Length_Age) + 1,] <- c(AgeCategory,SigTest$p.value)
  
}


Length_boxplots_AgeandFeed


```



## Length-Mass Relationship Modeling for Feed Groups 
Based on our distribution plots, we can be pretty certain a linear model is not appropriate
for our models. However, we will use the Residual plot to help us understand our model better.
Using these plots its pretty clear a polynomial model is more appropriate. 



```{r Relationship Modelling for Feed Groups}
y <- df_growth$Mass_mg
x <- df_growth$Length_mm

mod <- lm(y~x)

#Plot the residuals for a linear model. 
resid_panel(mod, plots='resid')


#Log transform both Mass and Length to compare a log transformed model against
#the original model
df_growth$Mass_log <- log(df_growth$Mass_mg)
df_growth$Length_log <- log(df_growth$Length_mm)
y2 <- df_growth$Mass_log
x2 <- df_growth$Length_log

mod_log <- lm(y2~x2)

#Compare the linear model to a log transformed model 
resid_compare(models=list(mod,
                          mod_log),
              plots= c("resid", "qq"),
              smoother = TRUE,
              qqbands = TRUE,
              title.opt = FALSE)


#SE represents the confidence interval

ggplot(df_growth, aes(x = Length_mm, y = Mass_mg, color = Feed_Group))+geom_point()+
  geom_smooth(method='lm',formula = y~poly(x,2,raw=TRUE),se=FALSE)


ggplot(df_growth, aes(x = Length_log, y = Mass_log, color = Feed_Group))+geom_point()+
  geom_smooth()

#Spearman Correlation, which does not require normality
df_growth_mysis <- df_growth %>%
  filter(.,Feed_Group=="Mysis")  
  cor(df_growth_mysis$Length_mm,df_growth_mysis$Mass_mg, method="spearman")

df_growth_gemma <- df_growth %>%
  filter(.,Feed_Group=="Gemma")  
  cor(df_growth_gemma$Length_mm,df_growth_gemma$Mass_mg, method="spearman")

#Visual representation of pearson correlation  
ggscatter(df_growth_mysis, x='Length_log', y='Mass_log', add = "reg.line", conf.int=TRUE, 
          cor.coef = TRUE, cor.method = "spearman", xlab = "Length (mm)", ylab = "Mass (mg)",
          title = "Mysis: Length Mass Log Relationship")


ggscatter(df_growth_gemma, x='Length_log', y='Mass_log', add = "reg.line", conf.int=TRUE, 
          cor.coef = TRUE, cor.method = "spearman", xlab = "Length (mm)", ylab = "Mass (mg)",
          title = "Gemma: Length Mass Log Relationship")


#Create linear model.
  
  
mysis_linear_model <- lm(Mass_log~Length_log,data=df_growth_mysis)
gemma_linear_model <- lm(Mass_log~Length_log,data=df_growth_gemma) 


plot(mysis_linear_model)





#model using one dataset for summary comparison
model <- lm(Mass_log~Length_log*Feed_Group, df_growth)

summary(model)  


ggplot(df_growth, aes(x=Length_log, y=Mass_log,group=Feed_Group))+geom_point(aes(color=Feed_Group))+
  geom_abline(intercept=)

#since we know based on qq plots and shapiro test, our set isn't normal, we will transform teh data via log transformation
#Do the transformed values pass the shapiro test?
qqnorm()
shapiro.test(resid(gemma_linear_model))



#Using ANOVA to compare 
```


## Length-Mass Cluster Modeling by Age and by Feed Groups

# Survival

## Signficance Testing between Census Events for Census and Deaths



```{r  Survival}

Summary_time_series_feed <- df_survival %>%
  group_by(Feed_Group,Date) %>%
  summarise(Census_avg=mean(Census), 
            Standard_Error=sd(Census)/sqrt(length(Census))) %>%
  ggplot(.,aes(x=Date,y=Census_avg,color=Feed_Group)) +geom_line(size=2)+
  geom_point(size = 4)+ geom_errorbar(aes(ymin=Census_avg-Standard_Error,
                                  ymax=Census_avg+Standard_Error),width=5) +
  scale_color_brewer(palette="Dark2") +
  labs(title='Average Feed Group Census over Time', 
       subtitle = 'Standard Error for Comparison',
       y = "Fish Census", x = "Date") +
  theme_specs


#Summarize data by feedgroup and date, the sum each group date, then plot
df_survival %>%
  group_by(Feed_Group,Date) %>%
    summarise(Census=sum(Census)) %>%
  ggplot(.,aes(x=Date,y=Census,color=Feed_Group)) +geom_line()

#Summarize the data by feedgroup and date, using average
df_survival %>%
  group_by(Feed_Group,Date) %>%
    summarise(Census=mean(Census)) %>%
  ggplot(.,aes(x=Date,y=Census,color=Feed_Group)) +geom_line()

#individual tank survival grouped by feed type
ggplot(df_survival, aes(x=Date, y=Census, group = Tank, color = Feed_Group))+geom_line()+geom_point()

#create a df with just the differences in tank over the time period
df_survival_summary_wide<-df_survival %>%
  group_by(Date) %>%
  filter(Date == '2020-10-15'|Date=='2021-07-06') %>%
  pivot_wider(names_from = Tank, values_from = Census,values_fill = 0)


#individual tank survival grouped by feed type
ggplot(df_survival, aes(x=Date, y=Census, group = Tank, color = Feed_Group))+geom_point()+geom_smooth()



#We will look to see if the regression lines of each  group is statistically 
#different using ANCOVA. Feed_Group is out group variable, census is dependent,
# and Date is our independent variable

mod1 <- aov(Census~Date*Feed_Group, data=df_survival)
summary(mod1)

#The summary of these results show a significant effect of Census and Date, but
#no significant interaction. Now we test for significant differences in the slope

mod2 <- aov(Census~Date+Feed_Group, data=df_survival)
summary(mod2)

#This result shows that Feed_group as a significant impact on the dependent 
#variable, which we interpret as a significant difference in intercepts.

#Now ANOVA

anova(mod1,mod2)

#This ANOVA comparison shows us  that there is no significant result of removing
#the interaction between the two graphs. 




#Convert POSIXct format to numeric for regression model
df_survival$Date.numeric <-as.numeric(df_survival$Date)/(24*60*60)
  
#subset survival groups

mysis_survival <-  df_survival %>%
    filter(Feed_Group == 'Mysis')
gemma_survival<-  df_survival %>%
  filter(Feed_Group == 'Gemma')
#Build linear regression models for both survival rates


linear_Mod_Mysis <- mysis_survival %>%
  lm(Census~Date.numeric, data=.)

linear_Mod_Gemma <- gemma_survival %>%
  lm(Census~Date.numeric, data=.)

#summary for linear modals. The shift from POSIXct fixed the issues I was having
summary(linear_Mod_Mysis)
summary(linear_Mod_Gemma)

#Summary indicates that Mysis and Gemma have similar intercepts 244.68,538.6,but gemma is higher which 
#makes sense given their starting numbers were the same, but their slopes are different, eventually
#Gemma will trace back at a higher y-intercept than Mysis. 


plot(Census~Date.numeric, data = df_survival, type = 'n')+
  points(mysis_survival$Date.numeric,mysis_survival$Census,pch=20)+
  points(gemma_survival$Date.numeric,gemma_survival$Census,pch=1)+
  abline(linear_Mod_Mysis,lty=1)+
  abline(linear_Mod_Gemma,lty=2)+
  legend("bottomleft", c("Mysis","Gemma"), lty=c(1,2), pch=c(20,1))

ggscatter(df_survival, x="Date", y="Census", color= "Feed_Group", add="reg.line")+
  stat_regline_equation(aes(label = paste(..eq.label..,..rr.label..,sep="~~~~"), color=Feed_Group))


#we can see that the models show a signficant difference between the two, with 
#mysis having a smaller intercept, showing gemma has a higher  survival rate
#

#Looking at this a different way, we truely only care that there is a difference at 
#the end of the high-aggression period. While it is interesting to see, where and
#when there may be different trends or how one trend impacts the other, this is something
#that requires a lot more study. 


#We are going to test the normality of residuals. 
model.metrics <- augment(mod2) %>%
subset(.,select=c(-.hat,-.sigma,-.fitted))

#shapiro wilk test if not significant (our case) tells us we can assume normality
shapiro_test(model.metrics$.resid)

#now we figure equality of variance of the residuals using Leven's test for ANCOVA
model.metrics %>% levene_test(.resid ~ Feed_Group) #this is also not significant

#look at outliers for the dataset

#Looking for standardized residuals greater than 3 in absolute value. Because we don't 
#see any we can assume no outliers. 
model.metrics %>%
  filter(abs(.std.resid) > 3) %>%
  as.data.frame()

res.aov <- df_survival %>% anova_test(Census~Date+Feed_Group) 

get_anova_table(res.aov)

library(emmeans)

#pairwise comparisons
pwc<-df_survival %>%
  emmeans_test(
    Census~Feed_Group, covariate=Date,
    p.adjust.method = "bonferroni")
  get_emmeans(pwc)
  
#Line_Plot
  
  lp <- ggline(
  get_emmeans(pwc), x = "Date", y = "emmean", 
  color = "Feed_Group", palette = "jco"
  ) +
  geom_errorbar(
    aes(ymin = conf.low, ymax = conf.high, color = Feed_Group), 
    width = 0.1
    )

  print(lp)  

#ANOVA on final set
ANOVA_df <- df_survival %>%
  filter(.,Date=='2021-07-06')

res2.aov <- ANOVA_df %>% anova_test(Census~Feed_Group) 

get_anova_table(res2.aov)  

#Compare the final set of data between groups using Welsh's T Test
t.test(ANOVA_df$Census~ANOVA_df$Feed_Group)
```
## Modeling for Census over Time

# Sex Sort

##Significance Testing between Feed Groups


```{r Sex Sort}

#From a first glance there is hardly any difference beteween the two groups in terms
#of sex, but we will run some Significance testing to make sure. An ANOVA is appropriate
#in these situations

#ANOVA
df_sex_sort %>%
  anova_test(Female ~ Group)

df_sex_sort %>%
  anova_test(Male ~ Group)

df_sex_sort %>%
  anova_test(Unknown ~ Group)


t.test(df_sex_sort$Female~df_sex_sort$Group)
t.test(df_sex_sort$Male~df_sex_sort$Group)
t.test(df_sex_sort$Unknown~df_sex_sort$Group)

#Not seeing any significant differences using ANOVA or Welech Two Sample t-test,
#which confirms what we saw in the percentage comparison earlier
```
# Fecundity

## Significance Testing between Feed Groups

```{r Fecundity}
t.test(Embryo.Viable ~ Group, data=df_fecundity)
```

